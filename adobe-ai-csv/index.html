// api/analyze.js
// Vercel serverless funkcija, kuri kviečia OpenAI Responses API su vizija (ESM versija)

export default async function handler(req, res) {
  if (req.method !== "POST") {
    res.statusCode = 405;
    res.setHeader("Content-Type", "application/json");
    res.end(JSON.stringify({ error: "Only POST allowed" }));
    return;
  }

  try {
    // --- body nuskaitymas iš stream'o ---
    let body = "";
    for await (const chunk of req) {
      body += chunk;
    }

    let parsed;
    try {
      parsed = JSON.parse(body || "{}");
    } catch (e) {
      res.statusCode = 400;
      res.setHeader("Content-Type", "application/json");
      res.end(JSON.stringify({ error: "Invalid JSON body" }));
      return;
    }

    const { imageBase64, filename } = parsed;

    if (!imageBase64) {
      res.statusCode = 400;
      res.setHeader("Content-Type", "application/json");
      res.end(JSON.stringify({ error: "Missing imageBase64" }));
      return;
    }

    // Paprastas dydžio check: labai dideli vaizdai -> graži klaida
    if (imageBase64.length > 12 * 1024 * 1024) {
      res.statusCode = 413;
      res.setHeader("Content-Type", "application/json");
      res.end(
        JSON.stringify({
          error: "Image too large",
          details: "Please upload images under ~8MB each."
        })
      );
      return;
    }

    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      res.statusCode = 500;
      res.setHeader("Content-Type", "application/json");
      res.end(JSON.stringify({ error: "Missing OPENAI_API_KEY on server" }));
      return;
    }

    const prompt = `
You are a professional Adobe Stock top-seller metadata expert.

Your task is to analyze the ENTIRE image (main subject, background, context, overall theme) and then choose ONE Adobe Stock category that best fits the **whole scene and commercial usage**, not just one object.

THINK IN THREE STEPS (internally, without showing the steps):

1) MAIN ELEMENTS
- Identify the main subject (what is most visually dominant or central).
- Identify important secondary elements (background, environment, props).
- Note if it is people, landscape, architecture, food, technology, animals, etc.

2) OVERALL SCENE & COMMERCIAL THEME
- Decide what the image is REALLY about as a stock asset.
- Example: 
  - A person with laptop at home → could be "lifestyle" or "business" depending on focus.
  - A scenic mountain with tiny hikers → more "landscape" than "people".
  - A flower macro with blurred background → more "plants and flowers" than "landscape".
- Think: "What would a buyer type into the search bar to find this image?"

3) CATEGORY SELECTION (1–21)
Choose the category by the **overall theme and use case**, NOT one random detail:

  1 Animals               – animals, pets, wildlife as main theme.
  2 Buildings and Architecture – architecture, buildings, interiors, cityscapes.
  3 Business              – office, corporate, finance, teamwork, professional life.
  4 Drinks                – beverages as main focus (coffee, tea, cocktails, etc.).
  5 The Environment       – ecology, nature protection, pollution, environmental issues.
  6 States of Mind        – emotional or conceptual mental states as main idea.
  7 Food                  – food, cooking, recipes, meals as main subject.
  8 Graphic Resources     – patterns, textures, icons, UI, templates, backgrounds.
  9 Hobbies and Leisure   – leisure, hobbies, games, fun, relaxation.
  10 Industry             – factories, work sites, industry machines, heavy production.
  11 Landscape            – wide nature views: mountains, fields, sky, sea, outdoor scenery.
  12 Lifestyle            – everyday life, home life, activities, living situations.
  13 People               – a person or people clearly the main focus (portraits, people shots).
  14 Plants and Flowers   – plants, trees, flowers as main focus, especially close-ups.
  15 Culture and Religion – traditions, rituals, symbols of culture or religion.
  16 Science              – labs, experiments, molecules, science visuals.
  17 Social Issues        – protests, poverty, inequality, social problem themes.
  18 Sports               – sport activities, athletes, training.
  19 Technology           – devices, screens, digital tech, AI visuals, servers, code.
  20 Transport            – vehicles (cars, trains, planes, bikes) as main theme.
  21 Travel               – famous places, travel destinations, tourism, trip concepts.

CATEGORY RULES:
- Categories CAN repeat across images.
- Do NOT choose category 13 (people) if no real or clearly visible person.
- Do NOT choose category 12 (lifestyle) unless daily life / lifestyle is clearly the main theme.
- If the image is mainly nature → prefer 11 (landscape) or 14 (plants and flowers) for close-ups.
- If the image is mostly architecture or city → prefer 2 (buildings) or 21 (travel) if it's a recognisable destination.
- Do NOT choose randomly – you must choose the best match for the whole scene.

TITLE (max ~180 characters)
- Commercial, literal, search-optimized.
- No emojis, hashtags, or quotes.

KEYWORDS (30–49)
- ORDER IS IMPORTANT: most commercially relevant first.
- Use search phrases buyers would actually type.
- Avoid useless adjectives and redundant synonyms.
- Use lowercase English only.

Return ONLY pure JSON:

{
  "title": "string",
  "keywords": ["string", "..."],
  "category": 1
}

Filename (may help, but ignore if irrelevant):
${filename || "unknown"}
    `.trim();

    // Responses API payload
    const payload = {
      model: "gpt-4.1-mini",
      input: [
        {
          role: "user",
          content: [
            { type: "input_text", text: prompt },
            { type: "input_image", image_url: `data:image/jpeg;base64,${imageBase64}` }
          ]
        }
      ],
      max_output_tokens: 400
    };

    const openaiRes = await fetch("https://api.openai.com/v1/responses", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify(payload)
    });

    if (!openaiRes.ok) {
      const text = await openaiRes.text().catch(() => "");
      throw new Error(`OpenAI API error: ${openaiRes.status} ${text}`);
    }

    const apiData = await openaiRes.json();

    // --- Extract text from Responses API ---
    let raw = "";
    if (apiData.output_text) {
      raw = apiData.output_text;
    } else if (
      Array.isArray(apiData.output) &&
      apiData.output[0]?.content?.[0]?.text
    ) {
      raw = apiData.output[0].content[0].text;
    }

    raw = (raw || "").trim();
    if (!raw) {
      throw new Error("Empty response from OpenAI");
    }

    // --- Robust JSON parse: ištraukiam { ... } gabalą ---
    let parsedJson;
    try {
      const firstBrace = raw.indexOf("{");
      const lastBrace = raw.lastIndexOf("}");
      if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
        const jsonSlice = raw.slice(firstBrace, lastBrace + 1);
        parsedJson = JSON.parse(jsonSlice);
      } else {
        throw new Error("No JSON object found in response");
      }
    } catch {
      throw new Error("Failed to parse JSON from OpenAI");
    }

    // TITLE – nelaužom žodžių, max ~200 simbolių
    let title = (parsedJson.title || "").toString().trim();
    if (!title) title = "ai generated image";

    const MAX_TITLE_CHARS = 200;
    if (title.length > MAX_TITLE_CHARS) {
      const slice = title.slice(0, MAX_TITLE_CHARS);
      const lastSpace = slice.lastIndexOf(" ");
      if (lastSpace > 40) {
        title = slice.slice(0, lastSpace);
      } else {
        title = slice;
      }
    }

    // KEYWORDS – iki 49, unikalūs, be tuščių
    let keywordsArray = Array.isArray(parsedJson.keywords)
      ? parsedJson.keywords.map((k) => String(k).toLowerCase().trim())
      : [];
    keywordsArray = keywordsArray
      .filter(Boolean)
      .filter((v, i, a) => a.indexOf(v) === i)
      .slice(0, 49);

    // CATEGORY – papildoma apsauga 1–21
    let category = parseInt(parsedJson.category, 10);
    if (!Number.isInteger(category)) {
      category = 11; // neutrali gamtos kategorija, jei visai nesąmonė
    } else if (category < 1) {
      category = 1;
    } else if (category > 21) {
      category = 21;
    }

    res.statusCode = 200;
    res.setHeader("Content-Type", "application/json");
    res.end(
      JSON.stringify({
        title,
        keywords: keywordsArray,
        category
      })
    );
  } catch (err) {
    res.statusCode = 500;
    res.setHeader("Content-Type", "application/json");
    res.end(
      JSON.stringify({
        error: "AI analysis failed",
        details: err.message || String(err)
      })
    );
  }
}
